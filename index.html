<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบสะสมแต้ม</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f5f5f5;padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;max-width:420px;margin:auto;box-shadow:0 4px 10px rgba(0,0,0,.1)}
input,button,select{width:100%;padding:10px;margin-top:6px;border-radius:8px}
button{border:none;cursor:pointer}
.add{background:#4caf50;color:#fff}
.redeem{background:#ff9800;color:#fff}
</style>
</head>
<body>

<div class="card">
<h2>ระบบสะสมแต้ม</h2>

<input id="username" placeholder="ชื่อผู้ใช้">
<button onclick="login()">เข้าสู่ระบบ</button>

<hr>
<p>ผู้ใช้: <b id="showUser">-</b></p>
<p>แต้ม: <b id="points">0</b></p>

<button class="add" onclick="addPoint()">+ เพิ่มแต้ม</button>

<h3>แลกของรางวัล</h3>
<select id="rewardSelect"></select>
<button class="redeem" onclick="redeem()">แลกรางวัล</button>
</div>

<script>
let users = JSON.parse(localStorage.getItem('users')||'{}');
let rewards = JSON.parse(localStorage.getItem('rewards')||'[]');
let currentUser = localStorage.getItem('currentUser');

if(currentUser && users[currentUser]!=null) loadUser(currentUser);
loadRewards();

// รับแต้มจาก QR
const p=new URLSearchParams(location.search);
if(p.get('qr')==='addpoint'){
  if(!currentUser) alert('กรุณาเข้าสู่ระบบก่อน');
  else{
    users[currentUser]=(users[currentUser]||0)+1;
    save(); loadUser(currentUser);
    alert('รับแต้ม +1');
  }
  history.replaceState({},'',location.pathname);
}

function save(){
  localStorage.setItem('users',JSON.stringify(users));
  localStorage.setItem('rewards',JSON.stringify(rewards));
  localStorage.setItem('currentUser',currentUser);
}

function login(){
  const u=username.value.trim();
  if(!u) return alert('ใส่ชื่อ');
  if(users[u]==null) users[u]=0;
  currentUser=u; save(); loadUser(u);
}

function loadUser(u){
  showUser.innerText=u;
  points.innerText=users[u];
}

function addPoint(){
  if(!currentUser) return alert('กรุณาเข้าสู่ระบบ');
  users[currentUser]++; save(); loadUser(currentUser);
}

function loadRewards(){
  rewardSelect.innerHTML='';
  if(rewards.length===0){
    rewardSelect.innerHTML='<option>ยังไม่มีของรางวัล</option>'; return;
  }
  rewards.forEach((r,i)=>{
    rewardSelect.innerHTML+=`<option value="${i}">${r.name} (${r.cost} แต้ม)</option>`;
  });
}

function redeem(){
  if(!currentUser) return alert('กรุณาเข้าสู่ระบบ');
  if(rewards.length===0) return alert('ยังไม่มีของรางวัล');
  const r=rewards[rewardSelect.value];
  if(users[currentUser]<r.cost) return alert('แต้มไม่พอ');
  users[currentUser]-=r.cost; save(); loadUser(currentUser);
  alert('แลก '+r.name+' สำเร็จ');
}
</script>
</body>
</html>
