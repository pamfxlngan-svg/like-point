<!DOCTYPE html><html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบสะสมแต้ม (ผู้ใช้)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px }
    .card { background:#fff; padding:20px; border-radius:12px; max-width:420px; margin:auto; box-shadow:0 4px 10px rgba(0,0,0,.1) }
    input, button, select { width:100%; padding:10px; margin-top:6px; border-radius:8px }
    button { border:none; cursor:pointer }
    .add { background:#4caf50; color:#fff }
    .redeem { background:#ff9800; color:#fff }
    .reset { background:#607d8b; color:#fff }
  </style>
</head>
<body><div class="card">
  <h2>ระบบสะสมแต้ม</h2><label>ชื่อผู้ใช้</label> <input id="username" placeholder="เช่น somchai" /> <button onclick="login()">เข้าสู่ระบบ</button>

  <hr />  <p>ผู้ใช้: <b id="showUser">-</b></p>
  <p>แต้ม: <b id="points">0</b></p><button class="add" onclick="addPoint()">+ เพิ่มแต้ม</button>

  <h3>แลกของรางวัล</h3>
  <select id="rewardSelect"></select>
  <button class="redeem" onclick="redeemReward()">แลกรางวัล</button><button class="reset" onclick="resetMe()">รีเซ็ตฉัน</button>

</div><script>
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  let currentUser = localStorage.getItem('currentUser');
  const rewards = JSON.parse(localStorage.getItem('rewards') || '[{"name":"น้ำเปล่า","cost":5},{"name":"กาแฟ","cost":10},{"name":"ขนม","cost":15}]');

  if (currentUser) loadUser(currentUser);
  loadRewards();

  const params = new URLSearchParams(window.location.search);
  if (params.get('qr') === 'addpoint' && currentUser) {
    users[currentUser] = (users[currentUser] || 0) + 1;
    save();
    alert('รับแต้มจาก QR แล้ว +1');
    history.replaceState({}, document.title, location.pathname);
  }

  function save() {
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('currentUser', currentUser);
    localStorage.setItem('rewards', JSON.stringify(rewards));
  }

  function login() {
    const u = username.value.trim();
    if (!u) return alert('กรุณาใส่ชื่อ');
    if (!users[u]) users[u] = 0;
    currentUser = u;
    loadUser(u);
    save();
  }

  function loadUser(u) {
    showUser.innerText = u;
    points.innerText = users[u];
  }

  function addPoint() {
    if (!currentUser) return alert('ยังไม่ได้เลือกผู้ใช้');
    users[currentUser]++;
    loadUser(currentUser);
    save();
  }

  function loadRewards() {
    rewardSelect.innerHTML = '';
    rewards.forEach((r, i) => {
      rewardSelect.innerHTML += `<option value="${i}">${r.name} (${r.cost} แต้ม)</option>`;
    });
  }

  function redeemReward() {
    const r = rewards[rewardSelect.value];
    if (!r) return;
    if (users[currentUser] < r.cost) return alert('แต้มไม่พอ');
    users[currentUser] -= r.cost;
    save();
    loadUser(currentUser);
    alert('แลก ' + r.name + ' สำเร็จ');
  }

  function resetMe() {
    if (confirm('รีเซ็ตแต้มของคุณ?')) {
      users[currentUser] = 0;
      save();
      loadUser(currentUser);
    }
  }
</script></body>
</html>
