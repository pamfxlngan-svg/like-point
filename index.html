<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบสะสมแต้ม</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f5f5f5;padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;max-width:420px;margin:auto}
input,button,select{width:100%;padding:10px;margin-top:6px;border-radius:8px}
button{border:none;cursor:pointer}
.add{background:#4caf50;color:#fff}
.redeem{background:#ff9800;color:#fff}
.logout{background:#9e9e9e;color:#fff}
</style>
</head>
<body>

<div class="card">
<h2>ระบบสะสมแต้ม</h2>

<div id="loginBox">
  <input id="username" placeholder="ชื่อผู้ใช้">
  <input id="password" type="password" placeholder="รหัสผ่าน">
  <button onclick="login()">เข้าสู่ระบบ / สมัคร</button>
</div>

<div id="app" style="display:none">
  <p>ผู้ใช้: <b id="showUser"></b></p>
  <p>แต้ม: <b id="points">0</b></p>

  <button class="add" onclick="addPoint()">+ เพิ่มแต้ม</button>

  <h3>แลกของรางวัล</h3>
  <select id="rewardSelect"></select>
  <button class="redeem" onclick="redeem()">แลกรางวัล</button>

  <button class="logout" onclick="logout()">ออกจากระบบ</button>
</div>
</div>

<script>
let data = JSON.parse(localStorage.getItem('data') || '{}');
let rewards = JSON.parse(localStorage.getItem('rewards') || '[]');
let currentUser = localStorage.getItem('currentUser');

if(currentUser && data[currentUser]){
  showApp(currentUser);
}

loadRewards();

// QR รับแต้ม
const q=new URLSearchParams(location.search);
if(q.get('qr')==='addpoint'){
  if(!currentUser) alert('กรุณาเข้าสู่ระบบก่อน');
  else{
    data[currentUser].points++;
    save(); update();
    alert('รับแต้ม +1');
  }
  history.replaceState({},'',location.pathname);
}

function save(){
  localStorage.setItem('data',JSON.stringify(data));
  localStorage.setItem('currentUser',currentUser);
}

function login(){
  const u=username.value.trim();
  const p=password.value;
  if(!u||!p) return alert('กรอกข้อมูลให้ครบ');

  if(!data[u]){
    // สมัครใหม่
    data[u]={password:p,points:0};
  }else{
    // ล็อกอิน
    if(data[u].password!==p) return alert('รหัสผ่านไม่ถูกต้อง');
  }
  currentUser=u;
  save();
  showApp(u);
}

function showApp(u){
  loginBox.style.display='none';
  app.style.display='block';
  showUser.innerText=u;
  update();
}

function update(){
  points.innerText=data[currentUser].points;
}

function addPoint(){
  data[currentUser].points++;
  save(); update();
}

function loadRewards(){
  rewardSelect.innerHTML='';
  if(rewards.length===0){
    rewardSelect.innerHTML='<option>ยังไม่มีของรางวัล</option>';return;
  }
  rewards.forEach((r,i)=>{
    rewardSelect.innerHTML+=`<option value="${i}">${r.name} (${r.cost} แต้ม)</option>`;
  });
}

function redeem(){
  if(rewards.length===0) return alert('ยังไม่มีของรางวัล');
  const r=rewards[rewardSelect.value];
  if(data[currentUser].points<r.cost) return alert('แต้มไม่พอ');
  data[currentUser].points-=r.cost;
  save(); update();
  alert('แลก '+r.name+' สำเร็จ');
}

function logout(){
  localStorage.removeItem('currentUser');
  location.reload();
}
</script>
</body>
</html>
